<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><title>LHCb-UK Software Training</title>
    
    
    <link rel="stylesheet" media="screen" type="text/css" 
      href="http://www.hep.phy.cam.ac.uk/lhcb/LHCbSoftTraining/documents/lhcb-cambridge-blue.css">

      <link rel="stylesheet" media="print" type="text/css" 
	href="http://www.hep.phy.cam.ac.uk/lhcb/LHCbSoftTraining/documents/lhcb-cambridge-print.css"></head><body>

  <body>

    <table id="titlebar">
      <tbody>
	<tr style="vertical-align: bottom;">
	  <td style="padding-bottom: 15px;">
	    <h1>LHCb Software Training: DaVinci</h1></td>
	  <td id="lhcblogo" style="text-align: right;">
	    <a href="http://cern.ch/lhcb">
	      <img src="http://lhcb.web.cern.ch/lhcb/lhcblogo.gif"></a></td>
	</tr>
      </tbody>
    </table>
    
    <div id="content">
      
      <h1><span lang="en-gb">Exercises linked to DaVinci session 1</span></h1>
      
      <p>
	The purpose of these exercises is to allow you to write a complete
	though simple selection algorithms for a typical decay: Bs->J/psiPhi.
	We start with a very simple algorithm that looks 
	at muons and fills some histograms.

		<h2>1. Setting up the environment</h2>
		... You should already have done that all</p>
		<ul>
			<li>Choose the DaVinci environment</li>
			<code class="display">cd $HOME/cmtuser/
DaVinciEnv v17r5
getpack Tutorial/Analysis v6r2
getpack Phys/DaVinci v17r5
cd Phys/DaVinci/v17r5/cmt
emacs requirements</code>
                        <li>add the following line </li>
<code class="display">use Analysis v6r2 Tutorial</code>
                        <li>Then go ahead</li>
<code class="display">cmt config
cmt br make
source setup.csh
cd $ANALYSISROOT</code>
		</ul>
		

		<h2>2. Start to write the options</h2></p>
		<ul>
			<li>Open a new file in the options directory and write</li>
<code class="display">#include "$DAVINCIROOT/options/DaVinciCommon.opts"
// load options for creation of "standard muons":
#include "$COMMONPARTICLESROOT/options/StandardMuons.opts"
// Don't forget the DLL
ApplicationMgr.DLLs += { "Analysis" };
//
// Let's make it a sequence
//
ApplicationMgr.TopAlg += { "GaudiSequencer/TutorialSeq" };
//
// J/spi->mumu selection
//
TutorialSeq.Members += { "TutorialAlgorithm" };
</code>
Now we need to write the algorithm!
		</ul>
		

		<h2>2. Start to write the algorithm</h2></p>
		<p>We will make a small algorithm that
			loops over muons and plots some variables.</p>
		<ul>

			<li>Open a file</li>
<code class="display">emacs src/TutorialAlgorithm.{cpp,h} &</code>
            <p>Answer "D" for DVAlgorithm twice</p>

			<li>Before you forget it, declare it to
			Analysis_load.cpp:</li>
<code class="display">DECLARE_ALGORITHM(TutorialAlgorithm)</code>

			<li>Now let's add something to the execute method:</li>
<code class="display">StatusCode TutorialAlgorithm::execute() {
  debug() << "==> Execute" << endmsg;
  StatusCode sc = StatusCode::SUCCESS ;

  // code goes here  
  LHCb::Particle::ConstVector muons = desktop()->particles(); 
  sc = loopOnMuons(muons);
  if (!sc) return sc;

  setFilterPassed(true);   // Set to true if event is accepted.
  return StatusCode::SUCCESS;
}</code>
                 <p>Here we get the particles from the hysDesktop tool 
		    and added a method that will do the actual work.
		    
			<li>Declare the method in th header file:</li>
<code class="display">private:
  StatusCode loopOnMuons(const LHCb::Particle::ConstVector&)const ;
</code>	    

			<li>Create it in the header file:</li>
<code class="display">//====================================================
// loop on muons
//====================================================
StatusCode TutorialAlgorithm::loopOnMuons(
      const LHCb::Particle::ConstVector& muons)const {

  StatusCode sc = StatusCode::SUCCESS ;
  
  // code goes here
  
  return sc ;
} </code>	    
 
<li>In the method add:</li>
<code class="display">  for ( LHCb::Particle::ConstVector::const_iterator im =  muons.begin() ;
        im != muons.end() ; ++im ){
    plot((*im)->p(),  "Muon P",  0., 50.*Gaudi::Units::GeV);  // momentum
    plot((*im)->pt(), "Muon Pt", 0., 5.*Gaudi::Units::GeV );  // Pt
    debug() << "Mu Momentum: " << (*im)->momentum() << endmsg ;
  }</code>	    

<li>Now get the primary vertices (outside the muons loop):</li>
<code class="display">LHCb::RecVertex::ConstVector pvs = desktop()->primaryVertices();</code>	

<li>And loop over them (inside...):</li>
<code class="display">    for ( LHCb::RecVertex::ConstVector::const_iterator ipv = 
          pvs.begin() ; ipv != pvs.end() ; ++ipv ){
      double IP, IPE;
      debug() << (*ipv)->position() << endmsg ;
      sc = geomDispCalculator()->calcImpactPar(*(*im), *(*ipv), IP, IPE);
      if (sc){
        plot(IP, "Muon IP", 0., 10.*Gaudi::Units::mm);
        if (IPE>0.) plot(IP/IPE, "Muon IP/error", 0., 10.);
      } 
    }
</code>	
		</ul>
		
		<h2>3. Run!</h2></p>
		<p>First we need some data</p>
                
		<ul>
		  <li>Go to the bookkeeping database <a href="http://lhcbbk.cern.ch/BkkWeb/Bkk/welcome.htm">here</a> (you probably want to bookmark that page...).
		  </li>
		  <ol>
<li> Click "Dataset Search"
<li> Select "Configuration = "<code>DC06 - v1-lumi2</code>"
<li> Select "Event type = <code>13144000 - Bs_JpsiPhi,mm</code>"
<li> Select "Step3 = <code>Brunel - v30r13</code>"  (or the latest available)
<li> Select "Datasets replicated at CERN"
<li> Select "Physical file name protocol = <code>castor</code>"
<li> Submit
<li> You get a <a href="http://lbnts2.cern.ch:8080/BkkServlets/EvTypeInfo?prev_fname=/&page_number=1&configuration=DC06+-+v1-lumi2&evt_type=13144001&dbase_vers=ANY^v30r13&replicat_lab=CERN&if_print=GaudiCard&ndata_per_page=200&ndata_per_job=&cards_type=physical&protocol=castor&InputFile0=DST+1&Program0=ANY^Brunel+-+v30r13&InputFile1=ANY^DIGI+1&Program1=ANY^Boole+-+v12r9&InputFile2=ANY^SIM+1&Program2=ANY^Gauss+-+v25r6">new page</a> with the data cards.
<li> Paste the contents into your options.
<p></p>
The bookkeeping can be very slow. Especially when 30 people try to access it at the same
time...
<p></p>
		</ol>
		<li>We want to save the histograms, so add the following line to your options:</li>
<code class="display">HistogramPersistencySvc.OutputFile = "DVHistos.root";</code>	
		<li>Now run:</li>
<code class="display">DaVinci $ANAYSISROOT/options/MyOptions.opts </code>	
              </ul>

		<h2>4. Look at the histograms</h2></p>
		<ul>
		<li>Open root</li>
<code class="display">root.exe</code>	
                <p>This will get you the version of root 
		   used by DaVinci. </p>
                <p>Note that  </p>
<code class="display">root</code>	
                <p>usually also works and gets you a nice welcome logo. 
		  But sometimes it simply doesn't work...</p>
		<li>The simplest way to look at histograms is to use the TBrowser</li>
<code class="display">TBrowser B</code>	
                <p>Which has a Windows-like look and feel.</p>
		<li>But if you just want to save the histograms, you could as well just paste the following in the root prompt</li>
<code class="display">TCanvas* c1 = new TCanvas("c1","Edinburgh",800,800);
c1->SetLogy();

TFile* F = new TFile("DVHistos.root") 
F->ls()
F->cd("TutorialAlgorithm")               
F->ls() 
TH1D* H1 = F->Get("TutorialAlgorithm/1")
TH1D* H2 = F->Get("TutorialAlgorithm/2")
TH1D* H3 = F->Get("TutorialAlgorithm/3")
TH1D* H4 = F->Get("TutorialAlgorithm/4")

H1->SetLineColor(2)
H1->SetLineWidth(3)
H1->Draw()
gPad->SaveAs("H1.eps");

H2->SetLineColor(2)
H2->SetLineWidth(3)
H2->Draw()
gPad->SaveAs("H2.eps");

H3->SetLineColor(2)
H3->SetLineWidth(3)
H3->Draw()
gPad->SaveAs("H3.eps");

H4->SetLineColor(2)
H4->SetLineWidth(3)
H4->Draw()
gPad->SaveAs("H4.eps");
</code>	
              <p>For sure one could do this shorter...</p>
		<li>To quit root:</li>
<code class="display">.q</code>	
              
		
              </ul>

</p>
<hr>
<p><span lang="en-gb">Last modified by P. Koppenburg, Dec 7 2006
</div>
</body></html>
