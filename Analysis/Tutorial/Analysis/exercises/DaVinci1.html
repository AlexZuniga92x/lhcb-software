<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><title>LHCb-UK Software Training</title>

    
    
    <link rel="stylesheet" media="screen" type="text/css" href="DaVinci1_files/lhcb-cambridge-blue.css">

      <link rel="stylesheet" media="print" type="text/css" href="DaVinci1_files/lhcb-cambridge-print.css"></head><body>

  

    <table id="titlebar">
      <tbody>
	<tr style="vertical-align: bottom;">
	  <td style="padding-bottom: 15px;">
	    <h1>LHCb Software Training: DaVinci</h1></td>
	  <td id="lhcblogo" style="text-align: right;">
	    <a href="http://cern.ch/lhcb">
	      <img src="DaVinci1_files/lhcblogo.gif"></a></td>
	</tr>
      </tbody>
    </table>
    
    <div id="content">
      
      <h1><span lang="en-gb">Exercises linked to DaVinci session 1</span></h1>
      
      <p>
	The purpose of these exercises is to allow you to write a complete
	though simple selection algorithms for a typical decay: Bs-&gt;J/psiPhi.
	We start with a very simple algorithm that looks 
	at muons and fills some histograms.

		</p><h2>1. Setting up the environment</h2>
		... You should already have done that all
		<ul>
			<li>Choose the DaVinci environment</li>
			<code class="display">cd $HOME/cmtuser/
DaVinciEnv v17r6
getpack Tutorial/Analysis v6r2
getpack Phys/DaVinci v17r6
cd Phys/DaVinci/v17r6/cmt
emacs requirements</code>
                        <li>add the following line </li>
<code class="display">use Analysis v6r2 Tutorial</code>
                        <li>Then go ahead</li>
<code class="display">cmt config
cmt br make
source setup.csh
cd $ANALYSISROOT</code>
		</ul>
		

		<h2>2. Start to write the options</h2>
		<ul>
			<li>Open a new file in the options directory and write</li>
<code class="display">#include "$DAVINCIROOT/options/DaVinciCommon.opts"
// load options for creation of "standard muons":
#include "$COMMONPARTICLESROOT/options/StandardMuons.opts"
// Don't forget the DLL
ApplicationMgr.DLLs += { "Analysis" };
//
// Let's make it a sequence
//
ApplicationMgr.TopAlg += { "GaudiSequencer/TutorialSeq" };
//
// J/psi-&gt;mumu selection
//
TutorialSeq.Members += { "TutorialAlgorithm" };
//
// Get the input data:
//
TutorialAlgorithm.PhysDesktop.InputLocations = { "Phys/StdLooseMuons" } ;
</code>
Now we need to write the algorithm!
		</ul>
		

		<h2>2. Start to write the algorithm</h2>
		<p>We will make a small algorithm that
			loops over muons and plots some variables.</p>
		<ul>

			<li>Open a file</li>
<code class="display">emacs src/TutorialAlgorithm.{cpp,h} &amp;</code>
            <p>Answer "D" for DVAlgorithm twice</p>

			<li>Before you forget it, declare it to
			Analysis_load.cpp:</li>
<code class="display">DECLARE_ALGORITHM(TutorialAlgorithm)</code>

			<li>Now let's add something to the execute method:</li>
<code class="display">StatusCode TutorialAlgorithm::execute() {
  debug() &lt;&lt; "==&gt; Execute" &lt;&lt; endmsg;
  StatusCode sc = StatusCode::SUCCESS ;

  // code goes here  
  LHCb::Particle::ConstVector muons = desktop()-&gt;particles(); 
  sc = loopOnMuons(muons);
  if (!sc) return sc;

  setFilterPassed(true);   // Set to true if event is accepted.
  return StatusCode::SUCCESS;
}</code>
                 <p>Here we get the particles from the hysDesktop tool 
		    and added a method that will do the actual work.
		    
			</p><li>Declare the method in the header file:</li>
<code class="display">private:
  StatusCode loopOnMuons(const LHCb::Particle::ConstVector&amp;)const ;
</code>	    

			<li>Create it in the cpp file:</li>
<code class="display">//====================================================
// loop on muons
//====================================================
StatusCode TutorialAlgorithm::loopOnMuons(
      const LHCb::Particle::ConstVector&amp; muons)const {

  StatusCode sc = StatusCode::SUCCESS ;
  
  // code goes here
  
  return sc ;
} </code>	    
 
<li>In the method add:</li>
<code class="display">  for ( LHCb::Particle::ConstVector::const_iterator im =  muons.begin() ;
        im != muons.end() ; ++im ){
    plot((*im)-&gt;p(),  "Muon P",  0., 50.*Gaudi::Units::GeV);  // momentum
    plot((*im)-&gt;pt(), "Muon Pt", 0., 5.*Gaudi::Units::GeV );  // Pt
    debug() &lt;&lt; "Mu Momentum: " &lt;&lt; (*im)-&gt;momentum() &lt;&lt; endmsg ;
  }</code>	    

<li>Now get the primary vertices (outside the muons loop):</li>
<code class="display">LHCb::RecVertex::ConstVector pvs = desktop()-&gt;primaryVertices();</code>	

<li>And loop over them (inside...):</li>
<code class="display">    for ( LHCb::RecVertex::ConstVector::const_iterator ipv = 
          pvs.begin() ; ipv != pvs.end() ; ++ipv ){
      double IP, IPE;
      debug() &lt;&lt; (*ipv)-&gt;position() &lt;&lt; endmsg ;
      sc = geomDispCalculator()-&gt;calcImpactPar(*(*im), *(*ipv), IP, IPE);
      if (sc){
        plot(IP, "Muon IP", 0., 10.*Gaudi::Units::mm);
        if (IPE&gt;0.) plot(IP/IPE, "Muon IP/error", 0., 10.);
      } 
    }
</code>	
		</ul>
		
		<h2>3. Run!</h2>
		<p>First we need some data</p>
                
		<ul>
		  <li>Go to the bookkeeping database <a href="http://lhcbbk.cern.ch/BkkWeb/Bkk/welcome.htm">here</a> (you probably want to bookmark that page...).
		  </li>
		  <ol>
<li> Click "Dataset Search"
</li><li> Select "Configuration = "<code>DC06 - v1-lumi2</code>"
</li><li> Select "Event type = <code>13144000 - Bs_JpsiPhi,mm</code>"
</li><li> Select "Step3 = <code>Brunel - v30r13</code>"  (or the latest available)
</li><li> Select "Datasets replicated at CERN"
</li><li> Select "Physical file name protocol = <code>castor</code>"
</li><li> Submit
</li><li> You get a <a href="http://lbnts2.cern.ch:8080/BkkServlets/EvTypeInfo?prev_fname=/&amp;page_number=1&amp;configuration=DC06+-+v1-lumi2&amp;evt_type=13144001&amp;dbase_vers=ANY%5Ev30r13&amp;replicat_lab=CERN&amp;if_print=GaudiCard&amp;ndata_per_page=200&amp;ndata_per_job=&amp;cards_type=physical&amp;protocol=castor&amp;InputFile0=DST+1&amp;Program0=ANY%5EBrunel+-+v30r13&amp;InputFile1=ANY%5EDIGI+1&amp;Program1=ANY%5EBoole+-+v12r9&amp;InputFile2=ANY%5ESIM+1&amp;Program2=ANY%5EGauss+-+v25r6">new page</a> with the data cards.
</li><li> Paste the contents into your options.
<p></p>
The bookkeeping can be very slow. Especially when 30 people try to access it at the same
time...
<p></p>
		<li>We don't want to run forever, so define the number of events:</li>
<code class="display">ApplicationMgr.EvtMax = 1000 ;</code>	
		</li>
		<li>We want to save the histograms, so add the following line to your options:</li>
<code class="display">HistogramPersistencySvc.OutputFile = "DVHistos.root";</code>	
		<li>Now run:</li>
<code class="display">DaVinci $ANALYSISROOT/options/MyOptions.opts </code>	
              </ul>

		<h2>4. Look at the histograms</h2>
		<ul>
		<li>Open root</li>
<code class="display">root.exe</code>	
                <p>This will get you the version of root 
		   used by DaVinci. </p>
                <p>Note that  </p>
<code class="display">root</code>	
                <p>usually also works and gets you a nice welcome logo. 
		  But sometimes it simply doesn't work...</p>
		<li>The simplest way to look at histograms is to use the TBrowser</li>
<code class="display">TBrowser B</code>	
                <p>Which has a Windows-like look and feel.</p>
		<li>But if you just want to save the histograms, you could as well just paste the following in the root prompt</li>
<code class="display">TCanvas* c1 = new TCanvas("c1","Edinburgh",800,800);
c1-&gt;SetLogy();

TFile* F = new TFile("DVHistos.root") 
F-&gt;ls()
F-&gt;cd("TutorialAlgorithm")               
F-&gt;ls() 
TH1D* H1 = F-&gt;Get("TutorialAlgorithm/1")
TH1D* H2 = F-&gt;Get("TutorialAlgorithm/2")
TH1D* H3 = F-&gt;Get("TutorialAlgorithm/3")
TH1D* H4 = F-&gt;Get("TutorialAlgorithm/4")

H1-&gt;SetLineColor(2)
H1-&gt;SetLineWidth(3)
H1-&gt;Draw()
gPad-&gt;SaveAs("H1.eps");

H2-&gt;SetLineColor(2)
H2-&gt;SetLineWidth(3)
H2-&gt;Draw()
gPad-&gt;SaveAs("H2.eps");

H3-&gt;SetLineColor(2)
H3-&gt;SetLineWidth(3)
H3-&gt;Draw()
gPad-&gt;SaveAs("H3.eps");

H4-&gt;SetLineColor(2)
H4-&gt;SetLineWidth(3)
H4-&gt;Draw()
gPad-&gt;SaveAs("H4.eps");
</code>	
              <p>For sure one could do this shorter...</p>
		<li>To quit root:</li>
<code class="display">.q</code>	
              
		
              </ul>


<hr>
<p><span lang="en-gb">Last modified by P. Koppenburg, Dec 7 2006
</span></p></div>
</body></html>
