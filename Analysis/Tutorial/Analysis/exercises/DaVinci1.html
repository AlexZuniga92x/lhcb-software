<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><title>LHCb-UK Software Training</title>
    
    
    <link rel="stylesheet" media="screen" type="text/css" 
      href="http://www.hep.phy.cam.ac.uk/lhcb/LHCbSoftTraining/documents/lhcb-cambridge-blue.css">

      <link rel="stylesheet" media="print" type="text/css" 
	href="http://www.hep.phy.cam.ac.uk/lhcb/LHCbSoftTraining/documents/lhcb-cambridge-print.css"></head><body>

  <body>

    <table id="titlebar">
      <tbody>
	<tr style="vertical-align: bottom;">

	  <td style="padding-bottom: 15px;">
	    <h1>LHCb Software Training: DaVinci</h1></td>
	  <td id="lhcblogo" style="text-align: right;">
	    <a href="http://cern.ch/lhcb">
	      <img src="http://lhcb.web.cern.ch/lhcb/lhcblogo.gif"></a></td>
	</tr>
      </tbody>
    </table>

    
    <div id="content">
      
            <h1><span lang="en-gb">Exercises linked to DaVinci session 1</span></h1>
	    
      <p>   
	The purpose of these exercises is to allow you to write a complete
	though simple selection algorithms for a typical decay: Bs-&gt;J/psiPhi.
	We start with a very simple algorithm that looks 
	at muons and fills some histograms.
	
		</p><h2>1. Creating Ganga template for DaVinci jobs, and intitial package build.</h2>
			You might already have done part of this. It doesn't harm to redo it but look for CVS errors when you <code>getpack</code>.
			<ul>
			<li>Set environment for Ganga:</li>
			
<code class="display">GangaEnv 4.2.6</code>
			<li>Start an interactive session:</li>
<code class="display">ganga</code>
You will be prompted for your grid password.
			 <li>At the ganga prompt type:</li>
<code class="display">t = JobTemplate( application = DaVinci( version = "v17r6" ) )
t.application.getpack( "Tutorial/Analysis v6r2" )
t.application.getpack( "Phys/DaVinci v17r6" )
t.application.masterpackage = "DaVinci v17r6 Phys"
t.application.optsfile = File( name = "~/cmtuser/Tutorial/Analysis/v6r2/options/myOptions.opts" )

!emacs $t.application.cmt_user_path/Phys/DaVinci/v17r6/cmt/requirements &</code>
		Be very careful not to copy-paste leading <b>spaces</b>; python does 
not like that at all.

                        <li>Add the line:</li>
<code class="display">use Analysis v6r2 Tutorial</code>
and save.

                        <li>At the ganga prompt:</li>
<code class="display">t.application.make()</code>
that may take a while...
		</ul>
		
		<h2>2. Start to write the options</h2>

			<ul>
				<li>Open the main options file
<code class="display">!emacs $t.application.optsfile.name &</code>
			<li>Write in the options file:</li>
<code class="display">#include "$DAVINCIROOT/options/DaVinciCommon.opts"
// load options for creation of "standard muons":
#include "$COMMONPARTICLESROOT/options/StandardMuons.opts"
// Don't forget the DLL
ApplicationMgr.DLLs += { "Analysis" };
//
// Let's make it a sequence
//
ApplicationMgr.TopAlg += { "GaudiSequencer/TutorialSeq" };
//
// J/psi-&gt;mumu selection
//
TutorialSeq.Members += { "TutorialAlgorithm" };
//
// Get the input data : all muons.
//
TutorialAlgorithm.PhysDesktop.InputLocations = { "Phys/StdLooseMuons" } ;
</code>
Since we want to make a J/psi->mumu we only need muons as input Particles.
The <code>StdLooseMuons</code> are all charged tracks compatible with being a muon. They
are made on demand when you need them.
<p></p>
Now we need to write the algorithm!
		</ul>
		

		<h2>2. Start to write the algorithm</h2>
		<p>We will make a small algorithm that
			loops over muons and plots some variables.</p>
		<ul>

			<li>Before you forget it, declare your new algorithm to
			Analysis_load.cpp:</li>
<code class="display">!emacs ~/cmtuser/Tutorial/Analysis/v6r2/src/Analysis_load.cpp &</code>
and add the line:
<code class="display">DECLARE_ALGORITHM(TutorialAlgorithm)</code>

			<li>Open the files for your algorithm:</li>
<code class="display">!emacs ~/cmtuser/Tutorial/Analysis/v6r2/src/TutorialAlgorithm.{cpp,h} &</code>
            <p>Answer "D" for DVAlgorithm twice. You can also do that from the shell 
	    prompt by opening another window.</p>

			<li>Create a new private method in the header file:</li>
<code class="display">private:
  StatusCode loopOnMuons(const LHCb::Particle::ConstVector&amp;)const ;
</code>	    

			<li>Now let's add something to the execute method in the cpp:</li>

<code class="display">StatusCode TutorialAlgorithm::execute() {
  debug() &lt;&lt; "==&gt; Execute" &lt;&lt; endmsg;
  StatusCode sc = StatusCode::SUCCESS ;

  // code goes here  
  LHCb::Particle::ConstVector muons = desktop()-&gt;particles(); 
  sc = loopOnMuons(muons);
  if (!sc) return sc;

  setFilterPassed(true);   // Set to true if event is accepted.
  return StatusCode::SUCCESS;
}</code>
                 <p>Here we get the particles from the PhysDesktop tool 
		    and call our new method.</p>
		    
			<li>Now implement the method in the cpp file:</li>

<code class="display">//====================================================
// loop on muons
//====================================================
StatusCode TutorialAlgorithm::loopOnMuons(
      const LHCb::Particle::ConstVector&amp; muons)const {

  StatusCode sc = StatusCode::SUCCESS ;
  
  // code goes here
  
  return sc ;
} </code>	    
 
<li>In the method add:</li>
<code class="display">  for ( LHCb::Particle::ConstVector::const_iterator im =  muons.begin() ;
        im != muons.end() ; ++im ){
    plot((*im)-&gt;p(),  "Muon P",  0., 50.*Gaudi::Units::GeV);  // momentum
    plot((*im)-&gt;pt(), "Muon Pt", 0., 5.*Gaudi::Units::GeV );  // Pt
    debug() &lt;&lt; "Mu Momentum: " &lt;&lt; (*im)-&gt;momentum() &lt;&lt; endmsg ;
  }</code>	    


<li>Now get the primary vertices (outside the muons loop):</li>
<code class="display">LHCb::RecVertex::ConstVector pvs = desktop()-&gt;primaryVertices();</code>	

<li>And loop over them (inside...):</li>
<code class="display">    for ( LHCb::RecVertex::ConstVector::const_iterator ipv = 
          pvs.begin() ; ipv != pvs.end() ; ++ipv ){
      double IP, IPE;
      debug() &lt;&lt; (*ipv)-&gt;position() &lt;&lt; endmsg ;
      sc = geomDispCalculator()-&gt;calcImpactPar(*(*im), *(*ipv), IP, IPE);
      if (sc){
        plot(IP, "Muon IP", 0., 10.*Gaudi::Units::mm);
        if (IPE&gt;0.) plot(IP/IPE, "Muon IP/error", 0., 10.);
      } 
    }
</code>	
<li>Now compile:</li>
<code class="display">t.application.make()</code>
<p>... and fix all compilation errors...</p>
		</ul>

		
		<h2>3. Run!</h2>
		<p>First we need some data</p>
                
		<ul>
		  <li>Go to the bookkeeping database <a href="http://lhcbbk.cern.ch/BkkWeb/Bkk/welcome.htm">here</a> (you probably want to bookmark that page...).
		  </li>
		  <ol>
<li> Click "Dataset Search"

</li><li> Select "Configuration = <code>DC06 - v1-lumi2</code>"
</li><li> Select "Event type = <code>13144001 - Bs_JpsiPhi,mm=CPV</code>"
</li><li> Select "Step3 = <code>Brunel - v30r13</code>"  (or the latest available)
</li><li> Select "Datasets replicated at : Anywhere (Grid only)"
</li><li> Submit
</li><li> You get a <a href="http://lbnts2.cern.ch:8080/BkkServlets/EvTypeInfo?prev_fname=/&page_number=1&configuration=DC06+-+v1-lumi2&evt_type=13144001&dbase_vers=ANY^v30r13&replicat_lab=ANY&if_print=GaudiCard&ndata_per_page=200&ndata_per_job=&cards_type=logical&protocol=rfio&InputFile0=DST+1&Program0=ANY^Brunel+-+v30r13&InputFile1=ANY^DIGI+1&Program1=ANY^Boole+-+v12r9&InputFile2=ANY^SIM+1&Program2=ANY^Gauss+-+v25r6">new page</a> with the data cards.
</li><li> Paste the contents into your options.
<p></p>
The bookkeeping can be very slow. Especially when 30 people try to access it at the same
time...
<p></p>
		<li>We don't want to run forever, so define the number of events:</li>
<code class="display">ApplicationMgr.EvtMax = 1000 ;</code>	
		</li>

		<li>We want to save the histograms, so add the following line to your options:</li>
<code class="display">HistogramPersistencySvc.OutputFile = "DVHistos.root";</code>	
		<li>Define a job:</li>
		<ul>
		<li>If you want the output to the terminal do:
<code class="display">j = Job( t, backend = Interactive() )</code>	
		<li>If you want the output in a file:
<code class="display">j = Job( t, backend = Local() )</code>	
		<li>If you want to use LSF:
<code class="display">j = Job( t, backend = LSF() )</code>	
		<li>If you want to use the grid:
<code class="display">j = Job( t, backend = Dirac() )</code>	
		<li>Before you submit you can export the file:
<code class="display">export (j , "Tutorial.py")</code>	
              </ul>
For small tests, the first two options are usually best.  For larger
    amounts of data, you'll need to run either on the LSF batch system
    or on the Grid.
		<li>Submit the job</li>
<code class="display">j.submit()</code>	
    When a job completes, unless you used the Interactive backend,
    standard output/error can be viewed with:

<code class="display">j.peek( "stdout" )
j.peek( "stderr" )</code>	
              </ul>

		<h2>4. Look at the histograms</h2>
		We'll do that outside of ganga... so exit back to shell.
		<ul>
		<li>Source the root setup scripts</li>
<code class="display">source $LHCBHOME/scripts/setup_external ROOT</code>	
		<li>Open root</li>
<code class="display">root.exe</code>	
                <p>Note that  </p>
<code class="display">root</code>	
                <p>usually also works and gets you a nice welcome logo. 
		  But sometimes it simply doesn't work...</p>
		<li>The simplest way to look at histograms is to use the TBrowser</li>
<code class="display">TBrowser B</code>	
                <p>Which has a Windows-like look and feel.</p>

		<li>But if you just want to save the histograms, you could as well just paste 
		the following in the root prompt</li>
<code class="display">TCanvas* c1 = new TCanvas("c1","Edinburgh",800,800);
c1-&gt;SetLogy();

TFile* F = new TFile("<some path>DVHistos.root")</code>
... make sure you give the full path to your file...
<code class="display">F-&gt;ls()
F-&gt;cd("TutorialAlgorithm")               
F-&gt;ls() 
TH1D* H1 = F-&gt;Get("TutorialAlgorithm/1")
TH1D* H2 = F-&gt;Get("TutorialAlgorithm/2")
TH1D* H3 = F-&gt;Get("TutorialAlgorithm/3")
TH1D* H4 = F-&gt;Get("TutorialAlgorithm/4")

H1-&gt;SetLineColor(2)
H1-&gt;SetLineWidth(3)
H1-&gt;Draw()
gPad-&gt;SaveAs("H1.eps");

H2-&gt;SetLineColor(2)
H2-&gt;SetLineWidth(3)
H2-&gt;Draw()
gPad-&gt;SaveAs("H2.eps");

H3-&gt;SetLineColor(2)
H3-&gt;SetLineWidth(3)
H3-&gt;Draw()
gPad-&gt;SaveAs("H3.eps");

H4-&gt;SetLineColor(2)
H4-&gt;SetLineWidth(3)
H4-&gt;Draw()
gPad-&gt;SaveAs("H4.eps");

</code>	
              <p>For sure one could do this shorter...</p>
		<li>To quit root:</li>
<code class="display">.q</code>	
              
		
              </ul>


<hr>
<p><span lang="en-gb">Last modified by P. Koppenburg, Dec 19 2006
</span></p></div>
</body></html>
