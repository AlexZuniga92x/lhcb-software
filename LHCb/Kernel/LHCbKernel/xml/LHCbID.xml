<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE gdd SYSTEM "gdd.dtd">
<gdd>
  <package name="LHCbKernel">

    <class
       name   = "LHCbID"
       desc   = "LHCb wide channel identifier"
       author = "Marco Cattaneo" >

       <import name="Kernel/VeloChannelID"/>
       <import name="Kernel/ITChannelID"/>
       <import name="Kernel/OTChannelID"/>
       <import name="Kernel/RichSmartID"/>
       <import name="Kernel/CaloCellID"/>

       &StlVector;

       <enum
          desc  = "types of sub-detector channel ID"
          name  = "channelIDType"
          value = "veloType=1, stType, otType, richType, caloType, muonType"
       />

      <enum
        name = 'SpecificMask'
        value = 'veloMask= 0x1FFFFFL,otMask=0x3FFFFFFL'
        desc = 'enumeration of the specific mask'
        access = 'PROTECTED' />

      <enum
        name = 'SpecificBits'
        value = 'veloBits=21,otBits=26'
        desc = 'enumeration of the specific bits'
        access = 'PROTECTED' />

       <attribute
          desc = "the internal representation" name="lhcbID"
          type = "bitfield"
          setMeth = "FALSE" >
            <bitfield desc='the detector channelID bits' length='28' name='channelID' setMeth='TRUE' getMeth='FALSE' />
            <bitfield desc='the LHCb detector type bits' length='4' name='detectorType' />
       </attribute>

       <method
         type    = 'bool'
         name    = 'operator=='
         argList = 'const LHCbID chanID'
         const   = 'TRUE'
         desc    = 'comparison equality'>
         <code>
  return (this->lhcbID() == chanID.lhcbID());
         </code>
       </method>

       <constructor
         desc     = "Constructor from VeloChannelID"
         initList = "m_lhcbID(0)">
          <arg const="TRUE" name="chanID" type="VeloChannelID" />
          <code>
  setDetectorType( veloType );
  setChannelID( chanID );
          </code>
       </constructor>

       <method
         type  = "bool"
         name  = "isVelo"
         const = 'TRUE'
         desc  = "return true if this is a Velo identifier">
         <code>
  return (veloType == detectorType()) ? true : false;
         </code>
       </method>

       <method
         type  = "VeloChannelID"
         name  = "veloID"
         const = 'TRUE'
         desc  = "return the VeloChannelID">
	 <code>
  return isVelo() ? channelID() : 0x0;
         </code>
       </method>

       <constructor
         desc     = "Constructor from ITChannelID"
         initList = "m_lhcbID(0)" >
          <arg const="TRUE" name="chanID" type="ITChannelID" />
          <code>
  setDetectorType( stType );
  setChannelID( ((chanID.uniqueWafer()-1)&gt;&gt;4) + (chanID.strip()-1) );
          </code>
       </constructor>

       <method
         type  = "bool"
         name  = "isST"
         const = 'TRUE'
         desc  = "return true if this is a Silicon Tracker identifier">
         <code>
  return (stType == detectorType()) ? true : false;
         </code>
       </method>

       <method
         type  = "ITChannelID"
         name  = "stID"
         const = 'TRUE'
         desc  = "return the ITChannelID">
	 <code>
  return isST() ? ( ((channelID()&amp;0xFFFF000)&lt;&lt;4)+(channelID()&amp;0xFFF) ) : 0xF0000000;
         </code>
       </method>

       <constructor
         desc     = "Constructor from OTChannelID"
         initList = "m_lhcbID(0)" >
        <arg const="TRUE" name="chanID" type="OTChannelID" />
        <code>
  setDetectorType( otType );
  setChannelID( chanID );
        </code>
       </constructor>

       <method
         type  = "bool"
         name  = "isOT"
         const = 'TRUE'
         desc  = "return true if this is a Outer Tracker identifier">
         <code>
  return (otType == detectorType()) ? true : false;
         </code>
       </method>

       <method
         type  = "OTChannelID"
         name  = "otID"
         const = 'TRUE'
         desc="return the OTChannelID">
	 <code>
  return isOT() ? channelID() : 0xF0000000;
         </code>
       </method>

       <constructor
         desc     = "Constructor from RichSmartID"
         initList = "m_lhcbID(0)" >
         <arg const="TRUE" name="chanID" type="RichSmartID" />
         <code>
  unsigned int richData = chanID.dataBitsOnly();
  if( chanID.pixelDataAreValid() ) richData += 0x8000000;
  setDetectorType( richType );
  setChannelID( richData );
         </code>
       </constructor>

       <method
         type  = 'bool'
         name  = 'isRich'
         const = 'TRUE'
         desc  = 'return true if this is a Rich identifier'>
         <code>
  return (richType == detectorType()) ? true : false;
         </code>
       </method>

       <method
         type  = "RichSmartID"
         name  = "richID"
         const = 'TRUE'
         desc  = "return the richSmartID">
	 <code>
  unsigned int rID = 0;
  if( isRich() ) {
    rID = channelID() &amp; 0x7000000;
    if( channelID() &amp;&amp; 0x8000000 ) rID += 0x7E000000;
  }
  return rID;
         </code>
       </method>

       <constructor
          desc     = "Constructor from CaloCellID"
          initList = "m_lhcbID(0)" >
          <arg const="TRUE" name="chanID" type="CaloCellID" />
         <code>
  setDetectorType( caloType );
  setChannelID( chanID.ccid() );
         </code>
       </constructor>

       <method
         type  = "bool"
         name  = "isCalo"
         const = 'TRUE'
         desc  = "return true if this is a Calo identifier">
         <code>
  return (caloType == detectorType()) ? true : false;
         </code>
       </method>

       <method
         type  = "CaloCellID"
         name  = "caloID"
         const = 'TRUE'
         desc  = "return the CaloCellID">
         <code>
  return isCalo() ? channelID() : 0xF0000000;
         </code>
       </method>

      <method
        type  = "unsigned int"
        name  = "channelID"
        const = 'TRUE'
        desc  = "return the internal channel ID">
        <code>
  unsigned mask = channelIDMask;
  unsigned bits  = channelIDBits;
  if (isVelo()) mask = veloMask;
  if (isOT()) mask = otMask;
  unsigned int id = (m_lhcbID &amp; mask) &gt;&gt; bits;
  return id;
        </code>
      </method>


      <method
        name    = 'setSpareBits'
        argList = 'unsigned int value'
        desc    = 'set the spare bits'>
        <code>
  if ( !( isVelo() || isOT() ) ) return;
  unsigned int mask = channelIDMask;
  unsigned int bits = channelIDBits;
  if (isVelo()) {
    mask &amp;= (~veloMask);
    bits = veloBits;
  } else if (isOT()) {
    mask &amp;= (~otMask);
    bits = otBits;
  }
  m_lhcbID &amp;= ~mask;
  m_lhcbID |= ((((unsigned int)value) &lt;&lt; bits) &amp; mask);
        </code>
      </method>

      <method
        type  = 'unsigned int'
        name  = 'spareBits'
        const = 'TRUE'
        desc  = 'retrieve the spare bits'>
        <code>
  if ( !( isVelo() || isOT() ) ) return 0;
  unsigned int mask = channelIDMask;
  unsigned int bits = channelIDBits;
  if (isVelo()) {
     mask &amp;= (~veloMask);	  
     bits = veloBits;
  } else if (isOT()) {
     mask &amp;= (~otMask);	  
     bits = otBits;
  }
  unsigned int val = ((m_lhcbID &amp; mask) &gt;&gt; bits);
  return val;
         </code>
       </method>


    
    </class>
  </package>
</gdd>
