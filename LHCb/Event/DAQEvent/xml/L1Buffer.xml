<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE gdd SYSTEM "gdd.dtd">
<gdd>

  <package name="DAQEvent">
<!-- ****************************************************************
     * L1Buffer                                                    *
     ****************************************************************-->
     <class 
      author="Helder Lopes"
      desc="L1 buffer"
      name="L1Buffer"
      location="DAQ/L1Buffer"
      id="1003"
     >
       <enum
        desc="Define the bank types for L1 trigger buffer"
        name="BankType"
        value="VeloR=0, VeloPhi, TT, L0, DAQ"
        access="PUBLIC"
       />
       <enum
        desc="Define source IDs for L0 banks"
        name="L0Source"
        value="L0DU=1, L0Calo, L0Muon"
        access="PUBLIC"
       />
       <enum
        desc="Define source IDs for DAQ banks"
        name="DAQSource"
        value="SFC=1, TRM"
        access="PUBLIC"
       />
       <base name="DataObject"/>
       &DataObject;
       <import name="Event/DAQTypes" soft="FALSE"/>
       <import name="GaudiKernel/GaudiException" soft="FALSE"/>
       <import name="l1_int" ignore="TRUE"/>
       <attribute
        desc="Initial amount of memory allocated in words(16 bit)"
        name="initialSize"
        type="long"
        init="10000"
        transient="TRUE"
        getMeth="FALSE"
        setMeth="FALSE"
       />
       <attribute
        desc="Current amount of memory allocated in words(16 bit)"
        name="allocatedSize"
        type="long"
        transient="TRUE"
        setMeth="FALSE"
       />
       <attribute
        desc="Current amount of memory filled with data in words(16 bit)"
        name="currentSize"
        type="long"
        transient="TRUE"
        setMeth="FALSE"
       />
       <attribute
        desc="Pointer to beggining of L1 buffer"
        name="buffer"
        type="l1_int*"
        transient="TRUE"
        setMeth="FALSE"
        getMeth="FALSE"
       />
       <attribute
         desc="Object to trigger offline serialization"
         name="serializationTrigger"
         type="BufferSerializer&lt;L1Buffer&gt;"
       />
       <constructor
        desc="Constructor: Allocate inital amount of memory"
	initList="m_initialSize(100),m_currentSize(0)"
	>
         <code> m_buffer = new l1_int[m_initialSize];
	        m_allocatedSize = m_initialSize;
	 </code>
       </constructor>
       <destructor
        desc="destructor: Deallocate memory"
	>
         <code> delete [] m_buffer; </code>
       </destructor>  
       <method
        desc="accessor method to retrieve pointer to beginning of buffer"
        name="buffer"
        type="l1_int *"
       >
         <code> return m_buffer; </code>
       </method>
       <method
        desc="Add a new bank of data to the buffer"
        name="addBank"
        type="void"
       >
       <arg type="int" name="sourceID" />
       <arg type="int" name="bankType"  />
       <arg type="l1_int *" name="data"    />
       <arg type="long" name="dataSize"  />
         <code> 
  long bankSize = 1 + dataSize ;
  if( bankSize &gt;126 ) {  // The maximum number of items in each banks is 126.
    bankSize = 126;
    throw GaudiException( "Size of data bank exceeds maximum (126). Excess ignored.",
                          "L1BufferException", StatusCode::FAILURE );
  }
  if( l1_int(sourceID)&gt;63 ) { // Maximum value for 6 bit field
      throw GaudiException( "sourceID value exceeds maximum (63).",
                            "L1BufferException", StatusCode::FAILURE );
  }
  long evtSize=m_currentSize+bankSize;
  if(evtSize &gt; m_allocatedSize ) reallocate( evtSize );
  long size=m_currentSize;
// Assigning 7 bits to bankSize (bankSize&lt;128), 6 bits to sourceID (sourceID &lt; 64) and
// 3 bits to bankType (bankType &lt; 8 )
  m_buffer[size++]=l1_int(bankSize)+(l1_int(sourceID)&lt;&lt;7)+(l1_int(bankType)&lt;&lt;13);

  for( long i =0; i&lt;dataSize;++i) m_buffer[size++] = *(data++);
  m_currentSize+=bankSize;
 </code>
       </method>
       <method
        desc="Add a new bank of data to the buffer"
        name="addBank"
        type="void"
       >
       <arg type="int" name="sourceID" />
       <arg type="int" name="bankType"  />
       <arg type="std::vector &lt;l1_int&gt;" name="data"    />
         <code> 
  long bankSize = 1 + data.size() ;
  if( bankSize &gt;126 ) {  // The maximum number of items in each banks is 126.
    bankSize = 126;
    throw GaudiException( "Size of data bank exceeds maximum (126). Excess ignored.",
                          "L1BufferException", StatusCode::FAILURE );
  }
  if( l1_int(sourceID)&gt;63 ) { // Maximum value for 6 bit field
      throw GaudiException( "sourceID value exceeds maximum (63).",
                            "L1BufferException", StatusCode::FAILURE );
  }
  long evtSize=m_currentSize+bankSize;
  if(evtSize &gt; m_allocatedSize ) reallocate( evtSize );
  long size=m_currentSize;
  m_buffer[size++]=l1_int(bankSize)+(l1_int(sourceID)&lt;&lt;7)+(l1_int(bankType)&lt;&lt;13);
  for( std::vector&lt;l1_int&gt;::iterator i =data.begin(); i!=data.end();++i) m_buffer[size++] = *i;
  m_currentSize+=bankSize;
 </code>
       </method>
       <method
        desc="Reallocate buffer if more space is necessary"
        name="reallocate"
        type="void"
	access="PRIVATE"
       >
       <arg type="long" name="evtSize" />
         <code>
// To avoid many reallocations we are giving at least m_initialSize extra space
  long newSize = evtSize+m_initialSize;
  l1_int * newBuffer = new l1_int[newSize];
  for( long i =0; i&lt;m_currentSize;++i) newBuffer[i] = m_buffer[i];
  m_allocatedSize=newSize;
  delete [] m_buffer;
  m_buffer = newBuffer;
	  </code>
       </method>
       <method type="StreamBuffer&amp;" 
        name="serialize"
        virtual="TRUE" 
        const="TRUE"
        desc="special serializer for writing">
        <arg name = "s" type = "StreamBuffer" inout = "BOTH" /> 
       </method>
       <method type="StreamBuffer&amp;"
        name="serialize"
        virtual="TRUE"
        desc="special serializer for reading">
        <arg name = "s" type = "StreamBuffer" inout = "BOTH" /> 
       </method>
       <method
        type="std::ostream&amp;"
        name="fillStream"
        virtual="TRUE"
        const="TRUE"
        desc="special serializer to ASCII stream">
        <arg name = "s" type = "std::ostream" inout = "BOTH" /> 
       </method>
     </class>
  </package>
</gdd>
