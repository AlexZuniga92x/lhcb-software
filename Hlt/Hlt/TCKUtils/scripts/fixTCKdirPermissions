#!/usr/bin/env python

import sys,os,fnmatch,errno
from stat import *

rwxrxrx = S_IRUSR | S_IWUSR | S_IXUSR | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH
rrr     = S_IRUSR |                     S_IRGRP |           S_IROTH

def updatePermissions( file, settings ) :
    #os.chmod(file,settings) # this is O(20%) faster, but touches files even if not needed...
    #evh: inclose the following os commands in try/except & ignore
    #the error arising from someone other than the owner trying to do a make
    try:
        if os.stat(file).st_mode != settings : os.chmod(file,settings)
    except OSError, x :
        if x.errno == errno.EPERM :
            print x
	else :
	        raise     	
   

dir = os.environ['HLTTCKROOT']+'/config'
print 'fixing permissions in ' + dir
for root,dirs,files in os.walk( dir ) :
   for d in fnmatch.filter(dirs,'CVS') : dirs.remove(d)
   for d in dirs  : updatePermissions( os.path.join(root,d) , rwxrxrx )
   for f in files : updatePermissions( os.path.join(root,f) , rrr )
