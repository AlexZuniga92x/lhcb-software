/** @file 
 *
 *  Hlt exclusive selections particle making
 *
 *  @author P. Koppenburg
 *  @date 2006-02-01
 */
//---------------------------------------------------------------------
// Charged ProtoParticles
//---------------------------------------------------------------------
Hlt2.Members += { "GaudiSequencer/SeqHlt2ProtoParticles" } ;
SeqHlt2ProtoParticles.MeasureTime = true ;
SeqHlt2ProtoParticles.IgnoreFilterPassed = true ; // do all
SeqHlt2ProtoParticles.Members += { "GaudiSequencer/SeqHlt2Charged" } ;
SeqHlt2Charged.MeasureTime = true ;
SeqHlt2Charged.IgnoreFilterPassed = false ;
/**
 * @todo TEMPORARY clone killer - waiting to understand duplicated tracks
 */
SeqHlt2Charged.Members += {
  "TrackEventCloneKiller/HltFullRecoTEMPORARYCloneKiller"} ;
HltFullRecoTEMPORARYCloneKiller.TracksInContainers = { "Hlt/Track/Forward_Alleys" };
HltFullRecoTEMPORARYCloneKiller.TracksOutContainer = "Hlt/Track/ForwardCLEANED" ;
HltFullRecoTEMPORARYCloneKiller.SkipSameContainerTracks = false ;
HltFullRecoTEMPORARYCloneKiller.CloneFinderTool.CompareAtLHCbIDsLevel = true ;
/**
 * @todo TEMPORARY kill huge events
 */
SeqHlt2Charged.Members += { "NumberOfTracksFilter" };
NumberOfTracksFilter.TrackLocations = { "Hlt/Track/ForwardCLEANED" };
NumberOfTracksFilter.MaxTracks = 1000 ;
/*
 * MC truth associated tracks
 */
SeqHlt2Charged.Members += { "GaudiSequencer/SeqTrueSignalTracks" }; // debug
/*
 * Hacking of errors
 */
SeqHlt2Charged.Members += { "HltInsertTrackErrParam"} ;
HltInsertTrackErrParam.InputLocation = "Hlt/Track/ForwardCLEANED" ;

//---------------------------------------------------------------------
// MuonID
//---------------------------------------------------------------------
SeqHlt2ProtoParticles.Members += { "GaudiSequencer/HltMuonIDSeq"} ;
HltMuonIDSeq.Members += { "MuonRec", "MuonID/HltMuonID" };
#include "$HLTSYSROOT/options/HltMuonID.opts"
HltMuonID.TrackLocation = "Hlt/Track/ForwardCLEANED" ;
HltMuonID.MuonIDLocation = "Hlt/Muon/MuonPID" ;
HltMuonID.MuonTrackLocation = "Hlt/Track/Muon";

//----------------------------------------------------------------------------------------------------
// C.Jones : RICH options
// Disabled by default. To enable uncomment the lines below
//----------------------------------------------------------------------------------------------------

// Global algorithm, using all three radiators
//#include "$RICHHLTSYSOPTS/GlobalPID_AllRads.opts"

// Global algorithm, using only the gas radiators (faster, but no low P PID)
//#include "$RICHHLTSYSOPTS/GlobalPID_GasRads.opts"

// Local algorithm (fastest)
#include "$RICHHLTSYSOPTS/LocalPID.opts"

// temporary, to use the cleaned forward tracks
ToolSvc.HLT.RichTrackCreator.TracksLocation = "Hlt/Track/ForwardCLEANED";

// Explicitly run the RICH reco sequence
//SeqHlt2Charged.Members += { "GaudiSequencer/HltRICHReco" };
// ... or on-demand only when really needed
//DataOnDemandSvc.Algorithms += {"DATA='/Event/Rec/Rich/HltPIDs' TYPE='GaudiSequencer/HltRICHReco'"};
//----------------------------------------------------------------------------------------------------

//---------------------------------------------------------------------
// ChargedProtoPAlg
//---------------------------------------------------------------------
SeqHlt2ProtoParticles.Members += { "ChargedProtoPAlg/HltChargedProtoPAlg" } ;
HltChargedProtoPAlg.InputTrackLocation = "Hlt/Track/ForwardCLEANED" ; // Correct this
// HltChargedProtoPAlg.InputTrackLocation = "Hlt/Track/Forward" ; // Correct this
HltChargedProtoPAlg.OutputProtoParticleLocation = "Hlt/ProtoP/Charged" ;
SeqHlt2ProtoParticles.Members += { "ChargedProtoCombineDLLsAlg/HltChargedProtoCombDLL" };
HltChargedProtoCombDLL.ProtoParticleLocation = "Hlt/ProtoP/Charged" ;

//---------------------------------------------------------------------
// ProtoParticles
//---------------------------------------------------------------------
//HltChargedProtoPAlg.InputRichPIDLocation = "Rec/Rich/HltPIDs";
HltChargedProtoPAlg.InputMuonPIDLocation = "Hlt/Muon/MuonPID";
// no calo yet
HltChargedProtoPAlg.UseCaloSpdPID = false ;
HltChargedProtoPAlg.UseCaloPrsPID = false ;
HltChargedProtoPAlg.UseCaloEcalPID = false ;
HltChargedProtoPAlg.UseCaloHcalPID = false ;
HltChargedProtoPAlg.UseCaloBremPID = false ;
//HltChargedProtoPAlg.UseRichPID = false ; // Protos will NOT have any RICH information - HltRichPIDsKaons will not work
HltChargedProtoPAlg.UseRichPID = true ;    // Use this to add RICH info to the HLT protos, needed for HltRichPIDsKaons
HltChargedProtoPAlg.UseMuonPID = true ;
HltChargedProtoPAlg.UseVeloPID = false ;

//---------------------------------------------------------------------
// Charged Particles - Here make all to Pi and K
//---------------------------------------------------------------------
SeqHlt2ProtoParticles.Members += { "PreLoadParticles/HltNoPIDsPions",
	                         "PreLoadParticles/HltNoPIDsKaons" }; 

HltNoPIDsPions.PhysDesktop.ParticleMakerType = "NoPIDsParticleMaker" ;
HltNoPIDsPions.PhysDesktop.NoPIDsParticleMaker.Inputs =  {"Hlt/ProtoP/Charged"} ;
HltNoPIDsPions.PhysDesktop.NoPIDsParticleMaker.Particle =  "pion" ;
HltNoPIDsPions.DecayDescriptor = "Pion" ;

HltNoPIDsKaons.PhysDesktop.ParticleMakerType = "NoPIDsParticleMaker" ;
HltNoPIDsKaons.PhysDesktop.NoPIDsParticleMaker.Inputs =  {"Hlt/ProtoP/Charged"} ;
HltNoPIDsKaons.PhysDesktop.NoPIDsParticleMaker.Particle =  "kaon" ;
HltNoPIDsKaons.DecayDescriptor = "Kaon" ;

// CRJ : Hack to make the 'NoPIDs' kaons use the RICH - Easy way to get everything downstream using the RICH
/*
HltNoPIDsKaons.PhysDesktop.ParticleMakerType = "CombinedParticleMaker" ;
HltNoPIDsKaons.PhysDesktop.CombinedParticleMaker.ExclusiveSelection = false ;
HltNoPIDsKaons.PhysDesktop.CombinedParticleMaker.InputProtoParticles = "Hlt/ProtoP/Charged";
HltNoPIDsKaons.PhysDesktop.CombinedParticleMaker.Particles = {"kaon"} ;
HltNoPIDsKaons.PhysDesktop.CombinedParticleMaker.TrackSelector.TrackTypes = {"Long"};
HltNoPIDsKaons.PhysDesktop.CombinedParticleMaker.Kaon.Selection = {"RequiresDet='RICH' CombDLL(k-pi)>'-5.0'"} ;
HltNoPIDsKaons.DecayDescriptor = "Kaon" ;
*/

//---------------------------------------------------------------------
// Kaons using RICH HLT reco results
//---------------------------------------------------------------------
SeqHlt2ProtoParticles.Members += { "PreLoadParticles/HltRichPIDsKaons" }; 

HltRichPIDsKaons.PhysDesktop.ParticleMakerType = "CombinedParticleMaker" ;
HltRichPIDsKaons.PhysDesktop.CombinedParticleMaker.ExclusiveSelection = false ;
HltRichPIDsKaons.PhysDesktop.CombinedParticleMaker.InputProtoParticles = "Hlt/ProtoP/Charged";
HltRichPIDsKaons.PhysDesktop.CombinedParticleMaker.Particles = {"kaon"} ;
HltRichPIDsKaons.PhysDesktop.CombinedParticleMaker.TrackSelector.TrackTypes = {"Long"};
HltRichPIDsKaons.PhysDesktop.CombinedParticleMaker.Kaon.Selection = {"RequiresDet='RICH' CombDLL(k-pi)>'-5.0'"} ;
HltRichPIDsKaons.DecayDescriptor = "Kaon" ;

//---------------------------------------------------------------------
// Muons sequence
//---------------------------------------------------------------------
SeqHlt2ProtoParticles.Members += { "GaudiSequencer/SeqHlt2Muons" } ;
SeqHlt2Muons.IgnoreFilterPassed = true ;
//---------------------------------------------------------------------
// Muons from Long tracks
//---------------------------------------------------------------------
SeqHlt2Muons.Members += { "PreLoadParticles/HltForwardMuons" }; 
HltForwardMuons.PhysDesktop.ParticleMakerType = "CombinedParticleMaker" ;
HltForwardMuons.PhysDesktop.CombinedParticleMaker.ExclusiveSelection = false ;
HltForwardMuons.PhysDesktop.CombinedParticleMaker.Particles = {"muon"} ;
HltForwardMuons.PhysDesktop.CombinedParticleMaker.Muon.Selection = {"RequiresDet='MUON'" } ;
HltForwardMuons.PhysDesktop.CombinedParticleMaker.TrackSelector.TrackTypes = {"Long"};
HltForwardMuons.PhysDesktop.CombinedParticleMaker.InputProtoParticles =  "/Event/Hlt/ProtoP/Charged" ;
HltForwardMuons.DecayDescriptor = "Muon" ;
//---------------------------------------------------------------------
// Special case for muons from L0
//---------------------------------------------------------------------
SeqHlt2Muons.Members += { "HltMuonForTES"} ;
//HltMuonForTES.InputSingleLocation ="Hlt/Track/MuonsForwardSingle";
//HltMuonForTES.InputDimuonLocation ="Hlt/Track/DiMuonsForward";
HltMuonForTES.InputSingleLocation ="Hlt/Selection/Track/MuonAndTVelo";
HltMuonForTES.InputDimuonLocation ="Hlt/Selection/Track/DiMuonAndTVelo";

HltMuonForTES.OutputMuonLocation ="Hlt/Track/MuonsFromAlley";
HltMuonForTES.OutputLevel =3;
// ToolSvc.CloneFinderTool.CompareAtLHCbIDsLevel=true;
HltMuonForTES.CloneFinderTool.CompareAtLHCbIDsLevel=true;

// Hacking of errors
SeqHlt2Muons.Members += { "HltInsertTrackErrParam/HltInsertTrackErrParamMuons"} ;
HltInsertTrackErrParamMuons.InputLocation = "Hlt/Track/MuonsFromAlley" ;

SeqHlt2Muons.Members += { "GaudiSequencer/SeqTrueSignalMuons" } ; // debug

SeqHlt2Muons.Members += { "ChargedProtoPAlg/HltMuonPAlg" } ;
//HltMuonPAlg.InputTrackLocation = "Hlt/Track/ForwardMuonRefined" ; 
//HltMuonPAlg.InputTrackLocation = "Hlt/Track/MuonsForward" ; 
HltMuonPAlg.InputTrackLocation = "Hlt/Track/MuonsFromAlley";
HltMuonPAlg.OutputProtoParticleLocation = "Hlt/ProtoP/Muons" ;
HltMuonPAlg.OutputLevel=3;
HltMuonPAlg.UseCaloSpdPID = false ;
HltMuonPAlg.UseCaloPrsPID = false ;
HltMuonPAlg.UseCaloEcalPID = false ;
HltMuonPAlg.UseCaloHcalPID = false ;
HltMuonPAlg.UseCaloBremPID = false ;
HltMuonPAlg.UseRichPID = false ;
HltMuonPAlg.UseMuonPID = false ; // not needed
HltMuonPAlg.UseVeloPID = false ;

SeqHlt2Muons.Members += { "PreLoadParticles/HltAlleyMuons" };
HltAlleyMuons.PhysDesktop.ParticleMakerType = "NoPIDsParticleMaker" ;
HltAlleyMuons.PhysDesktop.NoPIDsParticleMaker.Inputs =  { "Hlt/ProtoP/Muons"} ;
HltAlleyMuons.PhysDesktop.NoPIDsParticleMaker.Particle =  "muon" ;
HltAlleyMuons.DecayDescriptor = "Muon" ;

//---------------------------------------------------------------------
/// Now merge muons    @todo : kill clones
//---------------------------------------------------------------------
SeqHlt2Muons.Members += { "FilterDesktop/HltMuons"};
HltMuons.PhysDesktop.InputLocations = { "Phys/HltAlleyMuons", "Phys/HltForwardMuons" };

//---------------------------------------------------------------------
// Special case for electrons - NO ELECTRON ID YET
//---------------------------------------------------------------------
//SeqHlt2ProtoParticles.Members += { "PreLoadParticles/HltElectrons"};
HltElectrons.PhysDesktop.ParticleMakerType = "NoPIDsParticleMaker" ;
HltElectrons.PhysDesktop.NoPIDsParticleMaker.Inputs =  {"Hlt/ProtoP/Charged"} ;
HltElectrons.PhysDesktop.NoPIDsParticleMaker.Particle =  "electron" ;
HltElectrons.DecayDescriptor = "Electron" ;

//---------------------------------------------------------------------
// Special case for photons - NO PHOTONS YET
//---------------------------------------------------------------------

//---------------------------------------------------------------------
// Special case for Vzero particles
//---------------------------------------------------------------------
SeqHlt2ProtoParticles.Members += { "GaudiSequencer/SeqHlt2VzeroLL" } ;
SeqHlt2VzeroLL.MeasureTime = true ;
SeqHlt2VzeroLL.IgnoreFilterPassed = false ;
#include "$HLTKSHORTROOT/options/HltV0LL.opts"
HltV0LL.InputTrackContainer = "Hlt/Track/ForwardCLEANED";
// Kzero from two long tracks
SeqHlt2VzeroLL.Members += {
  "CreateHltVzero/HltV0LL",
  "GaudiSequencer/SeqMakeHltKsLL",
  "GaudiSequencer/SeqMakeHltLambdaLL"
};
SeqMakeHltKsLL.Members += { "HltV0ParticleMakerAlg/HltKsLLParticles" };
SeqMakeHltKsLL.IgnoreFilterPassed = true ;
HltKsLLParticles.V0Location = "Hlt/Vertex/KsLL" ;
HltKsLLParticles.MakeKs = true ;
HltKsLLParticles.MakeLambda = false ;
HltKsLLParticles.PhysDesktop.InputLocations = { "Phys/HltNoPIDsPions" };

SeqMakeHltLambdaLL.Members += { "HltV0ParticleMakerAlg/HltLambdaLLParticles" };
SeqMakeHltLambdaLL.IgnoreFilterPassed = true ;
HltLambdaLLParticles.V0Location = "Hlt/Vertex/KsLL" ;
HltLambdaLLParticles.MakeKs = false ;
HltLambdaLLParticles.MakeLambda = true ;
HltLambdaLLParticles.PhysDesktop.InputLocations = { "Phys/HltNoPIDsPions",
                                                    "Phys/HltNoPIDsProtons"};
/* printout 
SeqMakeHltKsLL.Members += {  "PrintTree/PrintKs" };
PrintKs.PhysDesktop.InputLocations = { "Phys/HltLambdaLLParticles" };
SeqMakeHltLambdaLL.Members += {  "PrintTree/PrintLambda" };
PrintLambda.PhysDesktop.InputLocations = { "Phys/HltLambdaLLParticles" };
*/

/* debug
HltKsLLParticles.OutputLevel = 2;
HltLambdaLLParticles.OutputLevel = 2;
*/
