########################################################################
# Psi2S -> mu mu
#
# This DaVinci script runs over MC psi(2S) -> mu+ mu-,
# such as that generated by the Gauss particle gun configuration ../gauss/Psi2SGun.py
# (or bookkeeping MC)
# It saves the invariant mass of the dimuon, i.e. the observed psi(2S) mass after FSR
#
# @author Jack Wimberley
# @date 2013-10-11
########################################################################

from Gaudi.Configuration import *
from Configurables import DaVinci
from GaudiKernel.SystemOfUnits import *

# -------
# OPTIONS
# -------

MessageSvc().OutputLevel = INFO
DaVinci().EvtMax = -1
DaVinci().PrintFreq = 100
DaVinci().HistogramFile = "PythiaPsi2S_histos.root"
DaVinci().TupleFile = "PythiaPsi2S.root"

DaVinci().DataType = "2012"
from Configurables import CondDB
CondDB().UseLatestTags = ["2012"]

# --------------
# MC TRUTH TUPLE
# --------------

from Configurables import DecayTreeTuple, MCDecayTreeTuple
from DecayTreeTuple.Configuration import *
mudecay = "psi(2S) => ^mu+ ^mu-"
tuple = MCDecayTreeTuple("PythiaPsi2STuple")
tuple.TupleName = "DecayTree"
tuple.addBranches({
    "Psi2S" : "psi(2S) => mu+ mu-"
    , "MuP" : "psi(2S) => ^mu+ mu-"
    , "MuM" : "psi(2S) => mu+ ^mu-"
    })
tuple.Decay = mudecay
tuple.ToolList = []
from Configurables import LoKi__Hybrid__TupleTool
from Configurables import LoKi__Hybrid__MCTupleTool
LTT = tuple.addTupleTool("LoKi::Hybrid::MCTupleTool/LTT")
LTT.Preambulo += ["from LoKiCore.functions import *"]
LTT.Variables = {
    "MCE" : "MCE"
    , "MCETA" : "MCETA"
    , "MCP" : "MCP"
    , "MCPX" : "MCPX"
    , "MCPY" : "MCPY"
    , "MCPZ" : "MCPZ"
    , "MCPT" : "MCPT"
    , "MCTHETA" : "MCTHETA"
    , "MCPHI" : "MCPHI"
    }
PSI2SLTT = tuple.Psi2S.addTupleTool("LoKi::Hybrid::MCTupleTool/PSI2SLTT")
PSI2SLTT.Preambulo += [
    "from LoKiCore.functions import *"
    , "from LoKiCore.math import *"
    , "E = MCCHILD(MCE,1) + MCCHILD(MCE,2)"
    , "PX = MCCHILD(MCPX,1) + MCCHILD(MCPX,2)"
    , "PY = MCCHILD(MCPY,1) + MCCHILD(MCPY,2)"
    , "PZ = MCCHILD(MCPZ,1) + MCCHILD(MCPZ,2)"
    ]
PSI2SLTT.Variables = { "MM" : "sqrt(E*E - PX*PX - PY*PY - PZ*PZ)/1000" }

DaVinci().appendToMainSequence( [ tuple ] )
